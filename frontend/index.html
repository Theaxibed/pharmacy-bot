<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f0f4ff;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --success: #16a34a;
      --success-light: #dcfce7;
      --danger: #dc2626;
      --danger-light: #fee2e2;
      --warn: #d97706;
      --warn-light: #fef3c7;
      --muted: #94a3b8;
      --text: #0f172a;
      --text2: #475569;
      --border: #e2e8f0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 90px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      background: var(--primary);
      color: white;
      padding: 14px 16px 10px;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 12px rgba(37,99,235,.35);
    }
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 17px; font-weight: 700; }
    .rep-badge {
      background: rgba(255,255,255,.2);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .header-sub { font-size: 12px; opacity: .75; margin-top: 3px; }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid var(--border);
      position: sticky; top: 55px; z-index: 99;
    }
    .tab {
      flex: 1; padding: 11px 8px;
      text-align: center; font-size: 13px; font-weight: 600;
      color: var(--muted); cursor: pointer;
      border-bottom: 3px solid transparent; margin-bottom: -2px;
      transition: all .2s;
    }
    .tab.active { color: var(--primary); border-color: var(--primary); }
    .tab-badge {
      display: inline-block; background: var(--danger);
      color: white; border-radius: 10px; font-size: 10px;
      padding: 1px 5px; margin-left: 4px; font-weight: 700;
    }

    /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
    .search-box { padding: 10px 14px; background: white; border-bottom: 1px solid var(--border); }
    .search-box input {
      width: 100%; padding: 9px 14px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 14px; outline: none; background: var(--bg);
    }
    .search-box input:focus { border-color: var(--primary); background: white; }

    /* ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ */
    .products-list { padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }

    .product-card {
      background: var(--card); border-radius: 14px;
      padding: 13px 14px; border: 1.5px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,.05);
      transition: border-color .15s;
    }
    .product-card.in-cart { border-color: var(--primary); }
    .product-card.out-of-stock { opacity: .5; }

    .product-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
    .product-name { font-size: 14px; font-weight: 700; line-height: 1.3; }
    .product-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .product-price { font-size: 13px; font-weight: 700; color: var(--primary); margin-top: 3px; }

    .stock-badge {
      font-size: 11px; font-weight: 700;
      padding: 3px 8px; border-radius: 20px; white-space: nowrap; flex-shrink: 0;
    }
    .badge-ok   { background: var(--success-light); color: var(--success); }
    .badge-low  { background: var(--warn-light); color: var(--warn); }
    .badge-zero { background: var(--danger-light); color: var(--danger); }

    .product-controls { display: flex; align-items: center; margin-top: 10px; gap: 8px; }
    .qty-wrap {
      display: flex; align-items: center; gap: 4px;
      background: var(--bg); border-radius: 10px; padding: 3px 6px;
    }
    .qty-btn {
      width: 30px; height: 30px; border: none; border-radius: 8px;
      background: var(--primary); color: white;
      font-size: 20px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      line-height: 1; transition: background .1s;
    }
    .qty-btn:disabled { background: var(--muted); cursor: default; }
    .qty-btn:active { background: #1d4ed8; }
    .qty-input {
      width: 46px; text-align: center; border: none;
      background: transparent; font-size: 15px; font-weight: 700;
      color: var(--text); outline: none;
    }
    .add-btn {
      flex: 1; padding: 9px 10px; border: none; border-radius: 10px;
      background: var(--primary-light); color: var(--primary);
      font-size: 13px; font-weight: 700; cursor: pointer; transition: all .15s;
    }
    .add-btn.in-cart { background: var(--primary); color: white; }
    .add-btn:disabled { background: var(--border); color: var(--muted); cursor: default; }

    /* ‚îÄ‚îÄ CART ‚îÄ‚îÄ */
    .cart-wrap { padding: 10px 14px; display: flex; flex-direction: column; gap: 10px; }

    /* Payment toggle */
    .payment-toggle {
      background: white; border-radius: 14px; padding: 14px;
      border: 1.5px solid var(--border);
    }
    .payment-toggle-label { font-size: 12px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 10px; }
    .toggle-btns { display: flex; gap: 8px; }
    .toggle-btn {
      flex: 1; padding: 10px; border: 2px solid var(--border);
      border-radius: 10px; font-size: 14px; font-weight: 700;
      cursor: pointer; background: white; color: var(--text2); transition: all .2s;
      text-align: center;
    }
    .toggle-btn.active-100 { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
    .toggle-btn.active-50  { border-color: var(--warn); background: var(--warn-light); color: var(--warn); }

    /* Cart items */
    .cart-items-block { background: white; border-radius: 14px; border: 1.5px solid var(--border); overflow: hidden; }
    .cart-items-header {
      padding: 12px 14px; border-bottom: 1px solid var(--border);
      font-size: 12px; font-weight: 700; color: var(--text2);
      text-transform: uppercase; letter-spacing: .5px;
    }
    .cart-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; border-bottom: 1px solid var(--border);
    }
    .cart-item:last-child { border-bottom: none; }
    .cart-item-info { flex: 1; min-width: 0; }
    .cart-item-name { font-size: 14px; font-weight: 600; }
    .cart-item-price-line { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .cart-item-total { font-size: 13px; font-weight: 700; color: var(--primary); white-space: nowrap; }

    /* inline qty editor in cart */
    .cart-qty-wrap {
      display: flex; align-items: center; gap: 3px;
      background: var(--bg); border-radius: 8px; padding: 2px 4px;
    }
    .cart-qty-btn {
      width: 26px; height: 26px; border: none; border-radius: 6px;
      background: var(--primary); color: white; font-size: 16px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;
    }
    .cart-qty-btn.remove { background: var(--danger); }
    .cart-qty-input {
      width: 38px; text-align: center; border: none;
      background: transparent; font-size: 14px; font-weight: 700;
      color: var(--text); outline: none;
    }

    /* Summary */
    .cart-summary { background: white; border-radius: 14px; border: 1.5px solid var(--border); padding: 14px; }
    .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .summary-row-label { font-size: 13px; color: var(--text2); }
    .summary-row-val { font-size: 13px; font-weight: 600; }
    .summary-divider { border: none; border-top: 1px solid var(--border); margin: 8px 0; }
    .summary-total-label { font-size: 15px; font-weight: 700; }
    .summary-total-val { font-size: 18px; font-weight: 800; color: var(--primary); }
    .summary-total-val.half { color: var(--warn); }

    /* Order form */
    .order-form { background: white; border-radius: 14px; border: 1.5px solid var(--border); padding: 14px; }
    .order-form h3 { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; }
    .form-field { margin-bottom: 12px; }
    .form-field label { font-size: 12px; font-weight: 600; color: var(--muted); display: block; margin-bottom: 4px; }
    .form-field input {
      width: 100%; padding: 10px 12px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 14px; outline: none; transition: border .2s;
    }
    .form-field input:focus { border-color: var(--primary); }
    .required { color: var(--danger); }

    .submit-btn {
      width: 100%; padding: 15px; border: none; border-radius: 12px;
      background: var(--primary); color: white;
      font-size: 16px; font-weight: 800; cursor: pointer; transition: background .15s;
    }
    .submit-btn:hover { background: #1d4ed8; }
    .submit-btn:disabled { background: var(--muted); cursor: default; }

    /* Empty cart */
    .cart-empty { text-align: center; padding: 60px 20px; color: var(--muted); }
    .cart-empty-icon { font-size: 48px; display: block; margin-bottom: 12px; }

    /* ‚îÄ‚îÄ BOTTOM BAR ‚îÄ‚îÄ */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--primary); color: white;
      padding: 12px 18px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 -2px 16px rgba(0,0,0,.15);
      cursor: pointer; transition: background .15s;
    }
    .bottom-bar:active { background: #1d4ed8; }
    .bottom-bar.hidden { display: none; }
    .bb-left { display: flex; flex-direction: column; }
    .bb-count { font-size: 20px; font-weight: 800; line-height: 1.1; }
    .bb-label { font-size: 11px; opacity: .8; }
    .bb-right { font-size: 18px; font-weight: 800; }

    /* ‚îÄ‚îÄ NOT REGISTERED ‚îÄ‚îÄ */
    #not-registered {
      display: none; padding: 40px 24px; text-align: center;
    }
    #not-registered .icon { font-size: 52px; display: block; margin-bottom: 16px; }
    #not-registered h2 { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
    #not-registered p { font-size: 14px; color: var(--text2); line-height: 1.6; }

    /* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
    #success-screen {
      display: none; padding: 60px 24px; text-align: center;
      flex-direction: column; align-items: center;
    }
    #success-screen.show { display: flex; }
    .success-icon { font-size: 64px; margin-bottom: 20px; }
    #success-screen h2 { font-size: 22px; font-weight: 800; color: var(--success); }
    #success-screen p { font-size: 14px; color: var(--text2); margin-top: 8px; line-height: 1.6; }
    .success-amounts { margin-top: 16px; background: var(--success-light); border-radius: 12px; padding: 14px 20px; width: 100%; }
    .sa-row { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; }
    .sa-total { font-weight: 800; font-size: 16px; color: var(--success); }
    .new-order-btn {
      margin-top: 24px; padding: 13px 30px; border: none; border-radius: 12px;
      background: var(--primary); color: white;
      font-size: 15px; font-weight: 700; cursor: pointer;
    }

    .loading { text-align: center; padding: 60px; color: var(--muted); }
    .spinner { display: block; font-size: 32px; margin: 0 auto 12px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <h1>üíä –ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã</h1>
    <span class="rep-badge" id="rep-badge">...</span>
  </div>
  <div class="header-sub" id="header-sub">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- NOT REGISTERED -->
<div id="not-registered">
  <span class="icon">üîí</span>
  <h2>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</h2>
  <p>–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –º–µ–¥–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å.<br>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.</p>
</div>

<!-- MAIN APP -->
<div id="main-app" style="display:none">

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" id="tab-catalog" onclick="switchTab('catalog')">üìã –ö–∞—Ç–∞–ª–æ–≥</div>
    <div class="tab" id="tab-cart" onclick="switchTab('cart')">
      üõí –ö–æ—Ä–∑–∏–Ω–∞<span class="tab-badge" id="cart-badge" style="display:none">0</span>
    </div>
  </div>

  <!-- CATALOG -->
  <div id="page-catalog">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="üîç –ù–∞–π—Ç–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç..." oninput="filterProducts()" />
    </div>
    <div class="products-list" id="products-list">
      <div class="loading"><span class="spinner">‚è≥</span>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</div>
    </div>
  </div>

  <!-- CART -->
  <div id="page-cart" style="display:none">
    <div class="cart-wrap">

      <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
      <div id="cart-empty" class="cart-empty">
        <span class="cart-empty-icon">üõí</span>
        <strong>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</strong><br>
        <span style="font-size:13px;margin-top:6px;display:block">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</span>
      </div>

      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã) -->
      <div id="cart-content" style="display:none">

        <!-- –í—ã–±–æ—Ä % –æ–ø–ª–∞—Ç—ã -->
        <div class="payment-toggle">
          <div class="payment-toggle-label">üí≥ –û–ø–ª–∞—Ç–∞</div>
          <div class="toggle-btns">
            <button class="toggle-btn active-100" id="btn-100" onclick="setPayment(100)">
              100% ‚Äî –ø–æ–ª–Ω–∞—è
            </button>
            <button class="toggle-btn" id="btn-50" onclick="setPayment(50)">
              50% ‚Äî –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
            </button>
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div class="cart-items-block">
          <div class="cart-items-header">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞—è–≤–∫–µ</div>
          <div id="cart-items-list"></div>
        </div>

        <!-- –ò—Ç–æ–≥ -->
        <div class="cart-summary" id="cart-summary"></div>

        <!-- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ -->
        <div class="order-form">
          <h3>üìù –î–∞–Ω–Ω—ã–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è</h3>
          <div class="form-field">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è <span class="required">*</span></label>
            <input type="text" id="field-institution" placeholder="–ê–ø—Ç–µ–∫–∞ ‚Ññ5 / –ì–ö–ë ‚Ññ1" />
          </div>
          <button class="submit-btn" id="submit-btn" onclick="submitOrder()">
            ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
          </button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- SUCCESS -->
<div id="success-screen">
  <div class="success-icon">üéâ</div>
  <h2>–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h2>
  <p id="success-text"></p>
  <div class="success-amounts" id="success-amounts"></div>
  <button class="new-order-btn" onclick="resetApp()">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar hidden" id="bottom-bar" onclick="switchTab('cart')">
  <div class="bb-left">
    <div class="bb-count" id="bb-count">0 –ø–æ–∑.</div>
    <div class="bb-label">–≤ –∫–æ—Ä–∑–∏–Ω–µ ‚Üí –æ—Ñ–æ—Ä–º–∏—Ç—å</div>
  </div>
  <div class="bb-right" id="bb-price">0.00</div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

const API = window.location.origin;
const tgUser = tg?.initDataUnsafe?.user;

let products = [];
let cart = {};        // { productId: quantity }
let paymentPercent = 100;
let repInfo = null;   // { code, full_name }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  if (!tgUser?.id) {
    // –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –Ω–µ –≤ Telegram ‚Äî –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥
    showApp({ code: 'TEST', full_name: '–¢–µ—Å—Ç' });
    return;
  }

  const res = await fetch(`${API}/api/orders/check-rep/${tgUser.id}`);
  const data = await res.json();

  if (!data.registered) {
    document.getElementById('not-registered').style.display = 'block';
    document.getElementById('header-sub').textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞';
    document.getElementById('rep-badge').textContent = 'üîí';
    return;
  }

  showApp(data);
}

function showApp(rep) {
  repInfo = rep;
  document.getElementById('rep-badge').textContent = `–ö–æ–¥: ${rep.code}`;
  document.getElementById('header-sub').textContent = rep.full_name;
  document.getElementById('main-app').style.display = 'block';
  loadProducts();
}

// ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProducts() {
  const res = await fetch(`${API}/api/products/`);
  products = await res.json();
  renderProducts(products);
}

function getStockBadge(p) {
  if (p.stock <= 0)  return `<span class="stock-badge badge-zero">–ù–µ—Ç</span>`;
  if (p.stock < 50)  return `<span class="stock-badge badge-low">–û—Å—Ç–∞–ª–æ—Å—å: ${p.stock}</span>`;
  return `<span class="stock-badge badge-ok">${p.stock} ${p.unit}</span>`;
}

function renderProducts(list) {
  const el = document.getElementById('products-list');
  if (!list.length) { el.innerHTML = '<div class="loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }

  el.innerHTML = list.map(p => {
    const inCart = cart[p.id] || 0;
    const disabled = p.stock <= 0;
    const priceStr = p.price > 0 ? `${p.price.toFixed(2)} / ${p.unit}` : '';
    return `
      <div class="product-card ${disabled ? 'out-of-stock' : ''} ${inCart ? 'in-cart' : ''}" id="pcard-${p.id}">
        <div class="product-top">
          <div style="min-width:0">
            <div class="product-name">${p.name}</div>
            ${p.description ? `<div class="product-desc">${p.description}</div>` : ''}
            ${priceStr ? `<div class="product-price">üí∞ ${priceStr}</div>` : ''}
          </div>
          ${getStockBadge(p)}
        </div>
        <div class="product-controls">
          <div class="qty-wrap">
            <button class="qty-btn" onclick="changeQty(${p.id},-1)" ${disabled?'disabled':''}>‚àí</button>
            <input class="qty-input" type="number" id="qty-${p.id}" value="${inCart||1}" min="1" max="${p.stock}" ${disabled?'disabled':''} onchange="onQtyInputChange(${p.id})" />
            <button class="qty-btn" onclick="changeQty(${p.id},1)" ${disabled?'disabled':''}>+</button>
          </div>
          <button class="add-btn ${inCart?'in-cart':''}" id="abtn-${p.id}"
            onclick="addToCart(${p.id})" ${disabled?'disabled':''}>
            ${inCart ? `‚úì –í –∫–æ—Ä–∑–∏–Ω–µ: ${inCart}` : '–î–æ–±–∞–≤–∏—Ç—å'}
          </button>
        </div>
      </div>`;
  }).join('');
}

function filterProducts() {
  const q = document.getElementById('search-input').value.toLowerCase();
  renderProducts(products.filter(p => p.name.toLowerCase().includes(q)));
}

// ‚îÄ‚îÄ CART LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function changeQty(pid, delta) {
  const input = document.getElementById(`qty-${pid}`);
  const p = products.find(x => x.id === pid);
  let v = Math.max(1, Math.min(parseInt(input.value) + delta, p?.stock || 9999));
  input.value = v;
  if (cart[pid]) { cart[pid] = v; updateUI(); }
}

function onQtyInputChange(pid) {
  if (cart[pid]) {
    const v = parseInt(document.getElementById(`qty-${pid}`).value) || 1;
    cart[pid] = v;
    updateUI();
  }
}

function addToCart(pid) {
  const p = products.find(x => x.id === pid);
  if (!p || p.stock <= 0) return;
  const qty = parseInt(document.getElementById(`qty-${pid}`).value) || 1;
  if (qty > p.stock) { alert(`–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ ${p.stock} ${p.unit}`); return; }
  if (p.limit_per_order && qty > p.limit_per_order) {
    alert(`–õ–∏–º–∏—Ç: –Ω–µ –±–æ–ª–µ–µ ${p.limit_per_order} ${p.unit} –∑–∞ —Ä–∞–∑`); return;
  }
  cart[pid] = qty;
  updateUI();
  tg?.HapticFeedback?.impactOccurred('light');

  // Update card
  const btn = document.getElementById(`abtn-${pid}`);
  const card = document.getElementById(`pcard-${pid}`);
  if (btn) { btn.className = 'add-btn in-cart'; btn.textContent = `‚úì –í –∫–æ—Ä–∑–∏–Ω–µ: ${qty}`; }
  if (card) card.classList.add('in-cart');
}

function cartRemove(pid) {
  delete cart[pid];
  updateUI();
  renderCartItems();
  // reset catalog card
  const btn = document.getElementById(`abtn-${pid}`);
  const card = document.getElementById(`pcard-${pid}`);
  if (btn) { btn.className = 'add-btn'; btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å'; }
  if (card) card.classList.remove('in-cart');
}

function cartChangeQty(pid, delta) {
  const p = products.find(x => x.id === pid);
  const input = document.getElementById(`cqty-${pid}`);
  let v = Math.max(1, Math.min(parseInt(input.value) + delta, p?.stock || 9999));
  input.value = v;
  cart[pid] = v;
  updateUI();
  renderCartItems();
  // sync catalog qty
  const catInput = document.getElementById(`qty-${pid}`);
  if (catInput) catInput.value = v;
  const btn = document.getElementById(`abtn-${pid}`);
  if (btn) btn.textContent = `‚úì –í –∫–æ—Ä–∑–∏–Ω–µ: ${v}`;
}

function cartQtyInput(pid) {
  const input = document.getElementById(`cqty-${pid}`);
  const p = products.find(x => x.id === pid);
  let v = parseInt(input.value) || 1;
  v = Math.max(1, Math.min(v, p?.stock || 9999));
  input.value = v;
  cart[pid] = v;
  updateUI();
}

function setPayment(pct) {
  paymentPercent = pct;
  document.getElementById('btn-100').className = `toggle-btn ${pct===100?'active-100':''}`;
  document.getElementById('btn-50').className  = `toggle-btn ${pct===50?'active-50':''}`;
  renderSummary();
  updateBottomBar();
}

// ‚îÄ‚îÄ RENDER CART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCartItems() {
  const entries = Object.entries(cart);
  if (!entries.length) return;

  document.getElementById('cart-items-list').innerHTML = entries.map(([pid, qty]) => {
    pid = parseInt(pid);
    const p = products.find(x => x.id === pid);
    const lineTotal = p ? (p.price * qty).toFixed(2) : '‚Äî';
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${p?.name || '?'}</div>
          <div class="cart-item-price-line">${p?.price?.toFixed(2)} √ó ... = <strong>${lineTotal}</strong></div>
        </div>
        <div class="cart-qty-wrap">
          <button class="cart-qty-btn remove" onclick="cartRemove(${pid})">‚úï</button>
          <button class="cart-qty-btn" onclick="cartChangeQty(${pid},-1)">‚àí</button>
          <input class="cart-qty-input" type="number" id="cqty-${pid}" value="${qty}"
            onchange="cartQtyInput(${pid})" min="1" max="${p?.stock||999}" />
          <button class="cart-qty-btn" onclick="cartChangeQty(${pid},1)">+</button>
        </div>
        <div class="cart-item-total">${lineTotal}</div>
      </div>`;
  }).join('');
}

function renderSummary() {
  const entries = Object.entries(cart);
  let full = 0;
  entries.forEach(([pid, qty]) => {
    const p = products.find(x => x.id === parseInt(pid));
    if (p) full += p.price * qty;
  });
  full = Math.round(full * 100) / 100;
  const pay = Math.round(full * paymentPercent) / 100;
  const isHalf = paymentPercent === 50;

  document.getElementById('cart-summary').innerHTML = `
    <div class="summary-row">
      <span class="summary-row-label">–ü–æ–∑–∏—Ü–∏–π –≤ –∑–∞—è–≤–∫–µ</span>
      <span class="summary-row-val">${entries.length} –ø—Ä–µ–ø–∞—Ä–∞—Ç(–∞)</span>
    </div>
    <div class="summary-row">
      <span class="summary-row-label">–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
      <span class="summary-row-val">${full.toFixed(2)}</span>
    </div>
    ${isHalf ? `
    <div class="summary-row">
      <span class="summary-row-label">–°–∫–∏–¥–∫–∞ (50%)</span>
      <span class="summary-row-val" style="color:var(--warn)">‚àí${(full-pay).toFixed(2)}</span>
    </div>` : ''}
    <hr class="summary-divider"/>
    <div class="summary-row">
      <span class="summary-total-label">üí≥ –ö –æ–ø–ª–∞—Ç–µ</span>
      <span class="summary-total-val ${isHalf?'half':''}">${pay.toFixed(2)}</span>
    </div>
    ${isHalf ? `<div style="font-size:11px;color:var(--warn);margin-top:4px;text-align:right">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 50%</div>` : ''}
  `;
}

function updateUI() {
  const entries = Object.entries(cart);
  const totalQty = entries.reduce((s, [, q]) => s + q, 0);

  // Tab badge
  const badge = document.getElementById('cart-badge');
  badge.textContent = totalQty;
  badge.style.display = totalQty ? 'inline-block' : 'none';

  // Empty/content
  const hasItems = entries.length > 0;
  document.getElementById('cart-empty').style.display = hasItems ? 'none' : 'block';
  document.getElementById('cart-content').style.display = hasItems ? 'flex' : 'none';
  if (document.getElementById('cart-content').style.display === 'flex') {
    document.getElementById('cart-content').style.flexDirection = 'column';
    document.getElementById('cart-content').style.gap = '10px';
  }

  if (hasItems) {
    renderCartItems();
    renderSummary();
  }

  updateBottomBar();
}

function updateBottomBar() {
  const entries = Object.entries(cart);
  if (!entries.length) {
    document.getElementById('bottom-bar').classList.add('hidden');
    return;
  }
  let full = 0;
  entries.forEach(([pid, qty]) => {
    const p = products.find(x => x.id === parseInt(pid));
    if (p) full += p.price * qty;
  });
  const pay = Math.round(full * paymentPercent) / 100;
  document.getElementById('bb-count').textContent = `${entries.length} –ø–æ–∑.`;
  document.getElementById('bb-price').textContent = `${pay.toFixed(2)}`;
  document.getElementById('bottom-bar').classList.remove('hidden');
}

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitOrder() {
  const institution = document.getElementById('field-institution').value.trim();
  if (!institution) { alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è'); return; }
  if (!Object.keys(cart).length) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return; }

  const btn = document.getElementById('submit-btn');
  btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  try {
    const res = await fetch(`${API}/api/orders/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegram_id: tgUser?.id || 0,
        telegram_username: tgUser?.username || '',
        institution,
        payment_percent: paymentPercent,
        items: Object.entries(cart).map(([pid, qty]) => ({
          product_id: parseInt(pid), quantity: qty
        })),
      }),
    });
    const data = await res.json();
    if (res.ok && data.ok) {
      showSuccess(data);
      tg?.HapticFeedback?.notificationOccurred('success');
    } else {
      alert(data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
      btn.disabled = false; btn.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    }
  } catch {
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
    btn.disabled = false; btn.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
  }
}

function showSuccess(data) {
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('bottom-bar').style.display = 'none';
  const sc = document.getElementById('success-screen');
  sc.classList.add('show');
  document.getElementById('success-text').textContent =
    `–ó–∞—è–≤–∫–∞ #${data.order_id} –æ—Ç ${repInfo?.full_name} –ø—Ä–∏–Ω—è—Ç–∞.`;
  document.getElementById('success-amounts').innerHTML = `
    <div class="sa-row"><span>–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span><span>${data.total_price?.toFixed(2)}</span></div>
    <div class="sa-row"><span>–û–ø–ª–∞—Ç–∞ ${data.payment_percent}%</span><span class="sa-total">${data.payment_amount?.toFixed(2)}</span></div>
  `;
}

function resetApp() {
  cart = {}; paymentPercent = 100;
  document.getElementById('success-screen').classList.remove('show');
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('bottom-bar').style.display = '';
  switchTab('catalog');
  loadProducts();
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('page-catalog').style.display = tab==='catalog'?'block':'none';
  document.getElementById('page-cart').style.display = tab==='cart'?'block':'none';
  document.getElementById('tab-catalog').classList.toggle('active', tab==='catalog');
  document.getElementById('tab-cart').classList.toggle('active', tab==='cart');
  if (tab==='cart') updateUI();
}

init();
</script>
</body>
</html>
