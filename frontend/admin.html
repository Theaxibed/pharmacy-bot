<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî PharmBot</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f1117; --surface: #181c27; --surface2: #1f2436;
      --border: #2a3047; --primary: #4f8ef7; --primary2: #2563eb;
      --success: #22c55e; --warn: #f59e0b; --danger: #ef4444;
      --text: #e8ecf4; --muted: #64748b;
      --mono: 'IBM Plex Mono', monospace; --sans: 'IBM Plex Sans', sans-serif;
    }
    body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; }

    /* LOGIN */
    #login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; background:radial-gradient(ellipse at 30% 20%,#1a2a4a,var(--bg) 60%); }
    .login-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:40px 44px; width:380px; box-shadow:0 24px 64px rgba(0,0,0,.5); }
    .login-logo { font-family:var(--mono); font-size:13px; font-weight:600; color:var(--primary); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; }
    .login-card h1 { font-size:24px; font-weight:700; margin-bottom:28px; }
    .login-label { font-size:12px; font-weight:600; color:var(--muted); letter-spacing:1px; text-transform:uppercase; display:block; margin-bottom:8px; }
    .login-input { width:100%; padding:12px 16px; background:var(--bg); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:var(--mono); font-size:15px; outline:none; transition:border .2s; margin-bottom:20px; }
    .login-input:focus { border-color:var(--primary); }
    .login-btn { width:100%; padding:13px; background:var(--primary); color:white; border:none; border-radius:10px; font-family:var(--sans); font-size:15px; font-weight:600; cursor:pointer; }
    .login-btn:hover { background:var(--primary2); }
    .login-error { color:var(--danger); font-size:13px; margin-top:10px; display:none; }

    /* LAYOUT */
    #admin-app { display:none; }
    .sidebar { position:fixed; top:0; left:0; bottom:0; width:220px; background:var(--surface); border-right:1px solid var(--border); padding:24px 0; display:flex; flex-direction:column; }
    .sidebar-logo { font-family:var(--mono); font-size:11px; font-weight:600; color:var(--primary); letter-spacing:2px; text-transform:uppercase; padding:0 20px 20px; border-bottom:1px solid var(--border); margin-bottom:16px; }
    .sidebar-logo span { display:block; font-size:16px; font-family:var(--sans); font-weight:700; color:var(--text); letter-spacing:0; margin-top:4px; }
    .nav-item { padding:10px 20px; cursor:pointer; font-size:14px; font-weight:500; color:var(--muted); display:flex; align-items:center; gap:10px; transition:all .15s; border-left:3px solid transparent; }
    .nav-item:hover { color:var(--text); background:var(--surface2); }
    .nav-item.active { color:var(--primary); background:rgba(79,142,247,.08); border-left-color:var(--primary); }
    .sidebar-footer { margin-top:auto; padding:16px 20px; border-top:1px solid var(--border); }
    .logout-btn { font-size:13px; color:var(--muted); cursor:pointer; background:none; border:none; font-family:var(--sans); }
    .logout-btn:hover { color:var(--danger); }
    .main { margin-left:220px; padding:32px 36px; min-height:100vh; }
    .page { display:none; }
    .page.active { display:block; }
    .page-header { margin-bottom:28px; display:flex; align-items:flex-start; justify-content:space-between; }
    .page-title { font-size:26px; font-weight:700; }
    .page-sub { font-size:14px; color:var(--muted); margin-top:4px; }

    /* BUTTONS */
    .btn { padding:9px 18px; border:none; border-radius:8px; font-family:var(--sans); font-size:13px; font-weight:600; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:6px; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-primary:hover { background:var(--primary2); }
    .btn-danger { background:rgba(239,68,68,.12); color:var(--danger); border:1px solid rgba(239,68,68,.25); }
    .btn-danger:hover { background:var(--danger); color:white; }
    .btn-ghost { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
    .btn-ghost:hover { border-color:var(--primary); color:var(--primary); }
    .btn-warn { background:rgba(245,158,11,.12); color:var(--warn); border:1px solid rgba(245,158,11,.25); }
    .btn-warn:hover { background:var(--warn); color:white; }
    .btn-sm { padding:6px 12px; font-size:12px; }

    /* TABLE */
    .table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    thead tr { border-bottom:1px solid var(--border); }
    thead th { padding:13px 16px; text-align:left; font-size:11px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--muted); }
    tbody tr { border-bottom:1px solid rgba(42,48,71,.6); transition:background .1s; }
    tbody tr:last-child { border-bottom:none; }
    tbody tr:hover { background:var(--surface2); }
    tbody td { padding:14px 16px; font-size:14px; vertical-align:middle; }
    .td-actions { display:flex; gap:6px; justify-content:flex-end; }

    /* BADGES */
    .badge { padding:3px 9px; border-radius:20px; font-size:11px; font-weight:700; font-family:var(--mono); }
    .badge-ok   { background:rgba(34,197,94,.12);  color:var(--success); }
    .badge-low  { background:rgba(245,158,11,.12); color:var(--warn); }
    .badge-zero { background:rgba(239,68,68,.12);  color:var(--danger); }
    .badge-off  { background:rgba(100,116,139,.12);color:var(--muted); }
    .badge-new  { background:rgba(79,142,247,.12); color:var(--primary); }
    .badge-processing { background:rgba(245,158,11,.12); color:var(--warn); }
    .badge-done { background:rgba(34,197,94,.12);  color:var(--success); }
    .badge-cancelled { background:rgba(100,116,139,.12); color:var(--muted); }

    /* MODAL */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(4px); }
    .modal-overlay.open { display:flex; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:32px; width:480px; max-width:95vw; box-shadow:0 32px 80px rgba(0,0,0,.6); animation:modal-in .2s ease; }
    @keyframes modal-in { from{transform:scale(.95);opacity:0} to{transform:scale(1);opacity:1} }
    .modal h2 { font-size:18px; font-weight:700; margin-bottom:20px; }
    .form-row { margin-bottom:16px; }
    .form-row label { display:block; font-size:12px; font-weight:600; color:var(--muted); letter-spacing:.5px; text-transform:uppercase; margin-bottom:6px; }
    .form-row input, .form-row textarea, .form-row select { width:100%; padding:10px 14px; background:var(--bg); border:1px solid var(--border); border-radius:9px; color:var(--text); font-family:var(--sans); font-size:14px; outline:none; transition:border .2s; }
    .form-row input:focus, .form-row textarea:focus { border-color:var(--primary); }
    .form-row-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:24px; }

    /* STATS */
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
    .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
    .stat-label { font-size:12px; font-weight:600; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:32px; font-weight:700; margin-top:6px; font-family:var(--mono); }

    /* ORDERS */
    .order-items-list { font-size:13px; color:var(--muted); margin-top:4px; display:flex; flex-wrap:wrap; gap:4px; }
    .order-item-tag { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:2px 7px; font-family:var(--mono); font-size:11px; }

    /* TOAST */
    #toast { position:fixed; bottom:28px; right:28px; background:var(--success); color:white; padding:12px 20px; border-radius:10px; font-size:14px; font-weight:600; transform:translateY(80px); opacity:0; transition:all .3s; z-index:9999; pointer-events:none; }
    #toast.show { transform:translateY(0); opacity:1; }
    #toast.error { background:var(--danger); }

    .empty-state { text-align:center; padding:60px; color:var(--muted); font-size:15px; }
    .empty-icon { font-size:40px; display:block; margin-bottom:12px; }

    /* INFO BOX */
    .info-box { background:rgba(79,142,247,.08); border:1px solid rgba(79,142,247,.2); border-radius:10px; padding:12px 16px; font-size:13px; color:var(--primary); margin-bottom:20px; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">PharmBot</div>
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    <label class="login-label">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
    <input class="login-input" type="password" id="login-token" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å..." onkeydown="if(event.key==='Enter')login()" />
    <button class="login-btn" onclick="login()">–í–æ–π—Ç–∏ ‚Üí</button>
    <div class="login-error" id="login-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
  </div>
</div>

<!-- ADMIN APP -->
<div id="admin-app">
  <div class="sidebar">
    <div class="sidebar-logo">PharmBot<span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span></div>
    <div class="nav-item active" id="nav-products"       onclick="switchPage('products')"><span>üíä</span> –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã</div>
    <div class="nav-item"        id="nav-reps"           onclick="switchPage('reps')"><span>üë§</span> –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏</div>
    <div class="nav-item"        id="nav-orders"         onclick="switchPage('orders')"><span>üì¶</span> –ó–∞—è–≤–∫–∏</div>
    <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button></div>
  </div>

  <div class="main">

    <!-- ‚ïê‚ïê PRODUCTS ‚ïê‚ïê -->
    <div id="page-products" class="page active">
      <div class="page-header">
        <div><div class="page-title">–ü—Ä–µ–ø–∞—Ä–∞—Ç—ã</div><div class="page-sub">–ö–∞—Ç–∞–ª–æ–≥, –æ—Å—Ç–∞—Ç–∫–∏, —Ü–µ–Ω—ã, –ª–∏–º–∏—Ç—ã</div></div>
        <button class="btn btn-primary" onclick="openAddProductModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>ID</th><th>–ü—Ä–µ–ø–∞—Ä–∞—Ç</th><th>–¶–µ–Ω–∞</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–ï–¥.</th><th>–õ–∏–º–∏—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr></thead>
          <tbody id="products-tbody"><tr><td colspan="8" class="empty-state"><span class="empty-icon">‚è≥</span>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïê‚ïê REPRESENTATIVES ‚ïê‚ïê -->
    <div id="page-reps" class="page">
      <div class="page-header">
        <div><div class="page-title">–ú–µ–¥–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏</div><div class="page-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ –∫–æ–¥–∞–º–∏</div></div>
        <button class="btn btn-primary" onclick="openAddRepModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="info-box">
        üí° –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å Telegram ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –µ–≥–æ –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É <strong>/start</strong> –∏ –ø–µ—Ä–µ–¥–∞—Ç—å ID –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>@userinfobot</strong>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>–ö–æ–¥</th><th>–§–ò–û</th><th>Telegram ID</th><th>–°—Ç–∞—Ç—É—Å</th><th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr></thead>
          <tbody id="reps-tbody"><tr><td colspan="5" class="empty-state"><span class="empty-icon">‚è≥</span>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïê‚ïê ORDERS ‚ïê‚ïê -->
    <div id="page-orders" class="page">
      <div class="page-header">
        <div><div class="page-title">–ó–∞—è–≤–∫–∏</div><div class="page-sub">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞—è–≤–æ–∫</div></div>
        <button class="btn btn-ghost" onclick="loadOrders()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">–í—Å–µ–≥–æ</div><div class="stat-value" id="stat-total">‚Äî</div></div>
        <div class="stat-card"><div class="stat-label">–ù–æ–≤—ã—Ö</div><div class="stat-value" id="stat-new" style="color:var(--primary)">‚Äî</div></div>
        <div class="stat-card"><div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div><div class="stat-value" id="stat-proc" style="color:var(--warn)">‚Äî</div></div>
        <div class="stat-card"><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div><div class="stat-value" id="stat-done" style="color:var(--success)">‚Äî</div></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>–î–∞—Ç–∞</th><th>–ö–æ–¥ / –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</th><th>–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr></thead>
          <tbody id="orders-tbody"><tr><td colspan="8" class="empty-state"><span class="empty-icon">‚è≥</span>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <h2 id="product-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç</h2>
    <input type="hidden" id="edit-product-id" />
    <div class="form-row">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
      <input type="text" id="prod-name" placeholder="–ê–º–æ–∫—Å–∏—Ü–∏–ª–ª–∏–Ω 500–º–≥" />
    </div>
    <div class="form-row">
      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <input type="text" id="prod-desc" placeholder="–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫ —à–∏—Ä–æ–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞" />
    </div>
    <div class="form-row-3" style="margin-bottom:16px">
      <div class="form-row" style="margin:0"><label>–ï–¥–∏–Ω–∏—Ü–∞</label>
        <select id="prod-unit"><option>—à—Ç</option><option>—É–ø–∞–∫</option><option>—Ñ–ª</option><option>–∞–º–ø</option><option>—Ç–∞–±</option><option>–º–ª</option><option>–≥</option></select>
      </div>
      <div class="form-row" style="margin:0"><label>–¶–µ–Ω–∞ –∑–∞ –µ–¥.</label>
        <input type="number" id="prod-price" placeholder="0.00" min="0" step="0.01" />
      </div>
      <div class="form-row" style="margin:0"><label>–û—Å—Ç–∞—Ç–æ–∫</label>
        <input type="number" id="prod-stock" placeholder="1000" min="0" />
      </div>
    </div>
    <div class="form-row">
      <label>–õ–∏–º–∏—Ç –Ω–∞ 1 –∑–∞—è–≤–∫—É (–ø—É—Å—Ç–æ = –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label>
      <input type="number" id="prod-limit" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 200" min="1" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('product-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- REP MODAL -->
<div class="modal-overlay" id="rep-modal">
  <div class="modal">
    <h2 id="rep-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</h2>
    <input type="hidden" id="edit-rep-id" />
    <div class="form-row-2" style="margin-bottom:16px">
      <div class="form-row" style="margin:0">
        <label>–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ *</label>
        <input type="text" id="rep-code" placeholder="4" />
      </div>
      <div class="form-row" style="margin:0">
        <label>Telegram ID *</label>
        <input type="number" id="rep-tgid" placeholder="123456789" />
      </div>
    </div>
    <div class="form-row">
      <label>–§–ò–û *</label>
      <input type="text" id="rep-name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('rep-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveRep()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal" style="width:360px">
    <h2 id="confirm-title">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
    <p id="confirm-text" style="font-size:14px;color:var(--muted);margin-top:8px"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('confirm-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" id="confirm-ok-btn">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API = window.location.origin;
let adminToken = '';

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function login() {
  const token = document.getElementById('login-token').value.trim();
  if (!token) return;
  const res = await fetch(`${API}/api/admin/products`, { headers: {'x-admin-token': token} });
  if (res.ok) {
    adminToken = token;
    sessionStorage.setItem('admin_token', token);
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-app').style.display = 'block';
    loadProducts();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}
function logout() { sessionStorage.removeItem('admin_token'); location.reload(); }
window.addEventListener('load', () => {
  const t = sessionStorage.getItem('admin_token');
  if (t) { document.getElementById('login-token').value = t; login(); }
});

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.getElementById(`nav-${page}`).classList.add('active');
  if (page === 'products') loadProducts();
  if (page === 'reps') loadReps();
  if (page === 'orders') loadOrders();
}

const h = t => ({ headers: {'x-admin-token': t || adminToken} });
const hj = () => ({ headers: {'x-admin-token': adminToken, 'Content-Type':'application/json'} });

// ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let products = [];
async function loadProducts() {
  const res = await fetch(`${API}/api/admin/products`, h());
  products = await res.json();
  renderProducts();
}

function stockBadge(p) {
  if (!p.is_active) return `<span class="badge badge-off">–°–∫—Ä—ã—Ç</span>`;
  if (p.stock <= 0)   return `<span class="badge badge-zero">0 ${p.unit}</span>`;
  if (p.stock < 50)   return `<span class="badge badge-low">${p.stock} ${p.unit}</span>`;
  return `<span class="badge badge-ok">${p.stock} ${p.unit}</span>`;
}

function renderProducts() {
  const tbody = document.getElementById('products-tbody');
  if (!products.length) { tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><span class="empty-icon">üíä</span>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç</div></td></tr>`; return; }
  tbody.innerHTML = products.map(p => `
    <tr style="${!p.is_active?'opacity:.5':''}">
      <td><span style="font-family:var(--mono);color:var(--muted)">${p.id}</span></td>
      <td><div style="font-weight:600">${p.name}</div>${p.description?`<div style="font-size:12px;color:var(--muted)">${p.description}</div>`:''}</td>
      <td style="font-family:var(--mono)">${p.price > 0 ? p.price.toFixed(2) : '‚Äî'}</td>
      <td>${stockBadge(p)}</td>
      <td style="color:var(--muted)">${p.unit}</td>
      <td style="font-family:var(--mono)">${p.limit_per_order || '‚Äî'}</td>
      <td><span class="badge ${p.is_active?'badge-ok':'badge-off'}">${p.is_active?'–ê–∫—Ç–∏–≤–µ–Ω':'–°–∫—Ä—ã—Ç'}</span></td>
      <td><div class="td-actions">
        <button class="btn btn-sm btn-ghost" onclick="openEditProductModal(${p.id})">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-warn" onclick="toggleProduct(${p.id})" title="${p.is_active?'–°–∫—Ä—ã—Ç—å':'–ü–æ–∫–∞–∑–∞—Ç—å'}">${p.is_active?'üôà':'üëÅÔ∏è'}</button>
        <button class="btn btn-sm btn-danger" onclick="confirmDelete('product',${p.id},'${p.name.replace(/'/g,"\\'")}')">üóëÔ∏è</button>
      </div></td>
    </tr>`).join('');
}

function openAddProductModal() {
  document.getElementById('product-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç';
  document.getElementById('edit-product-id').value = '';
  ['prod-name','prod-desc','prod-stock','prod-limit'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('prod-price').value = '';
  document.getElementById('prod-unit').value = '—à—Ç';
  openModal('product-modal');
}

function openEditProductModal(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  document.getElementById('product-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç';
  document.getElementById('edit-product-id').value = id;
  document.getElementById('prod-name').value = p.name;
  document.getElementById('prod-desc').value = p.description || '';
  document.getElementById('prod-unit').value = p.unit || '—à—Ç';
  document.getElementById('prod-price').value = p.price || '';
  document.getElementById('prod-stock').value = p.stock;
  document.getElementById('prod-limit').value = p.limit_per_order || '';
  openModal('product-modal');
}

async function saveProduct() {
  const id = document.getElementById('edit-product-id').value;
  const name = document.getElementById('prod-name').value.trim();
  if (!name) { showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', true); return; }
  const payload = {
    name, description: document.getElementById('prod-desc').value.trim(),
    unit: document.getElementById('prod-unit').value,
    price: parseFloat(document.getElementById('prod-price').value) || 0,
    stock: parseInt(document.getElementById('prod-stock').value) || 0,
    limit_per_order: parseInt(document.getElementById('prod-limit').value) || null,
  };
  const url = id ? `${API}/api/admin/products/${id}` : `${API}/api/admin/products`;
  const method = id ? 'PATCH' : 'POST';
  const res = await fetch(url, { method, ...hj(), body: JSON.stringify(payload) });
  if (res.ok) { closeModal('product-modal'); showToast(id ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ' : '–î–æ–±–∞–≤–ª–µ–Ω–æ'); loadProducts(); }
  else { const d = await res.json(); showToast(d.detail || '–û—à–∏–±–∫–∞', true); }
}

async function toggleProduct(id) {
  const res = await fetch(`${API}/api/admin/products/${id}/toggle`, { method:'POST', ...h() });
  if (res.ok) { showToast('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω'); loadProducts(); }
}

// ‚îÄ‚îÄ REPRESENTATIVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let reps = [];
async function loadReps() {
  const res = await fetch(`${API}/api/admin/reps`, h());
  reps = await res.json();
  renderReps();
}

function renderReps() {
  const tbody = document.getElementById('reps-tbody');
  if (!reps.length) { tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><span class="empty-icon">üë§</span>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div></td></tr>`; return; }
  tbody.innerHTML = reps.map(r => `
    <tr style="${!r.is_active?'opacity:.5':''}">
      <td><span style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--primary)">${r.code}</span></td>
      <td style="font-weight:600">${r.full_name}</td>
      <td><span style="font-family:var(--mono);color:var(--muted);font-size:13px">${r.telegram_id}</span></td>
      <td><span class="badge ${r.is_active?'badge-ok':'badge-off'}">${r.is_active?'–ê–∫—Ç–∏–≤–µ–Ω':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span></td>
      <td><div class="td-actions">
        <button class="btn btn-sm btn-ghost" onclick="openEditRepModal(${r.id})">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-warn" onclick="toggleRep(${r.id},${r.is_active})">${r.is_active?'üîí –ë–ª–æ–∫':'‚úÖ –†–∞–∑–±–ª–æ–∫'}</button>
        <button class="btn btn-sm btn-danger" onclick="confirmDelete('rep',${r.id},'${r.full_name.replace(/'/g,"\\'")}')">üóëÔ∏è</button>
      </div></td>
    </tr>`).join('');
}

function openAddRepModal() {
  document.getElementById('rep-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è';
  document.getElementById('edit-rep-id').value = '';
  ['rep-code','rep-tgid','rep-name'].forEach(id => document.getElementById(id).value = '');
  openModal('rep-modal');
}

function openEditRepModal(id) {
  const r = reps.find(x => x.id === id);
  if (!r) return;
  document.getElementById('rep-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è';
  document.getElementById('edit-rep-id').value = id;
  document.getElementById('rep-code').value = r.code;
  document.getElementById('rep-tgid').value = r.telegram_id;
  document.getElementById('rep-name').value = r.full_name;
  openModal('rep-modal');
}

async function saveRep() {
  const id = document.getElementById('edit-rep-id').value;
  const code = document.getElementById('rep-code').value.trim();
  const tgid = parseInt(document.getElementById('rep-tgid').value);
  const name = document.getElementById('rep-name').value.trim();
  if (!code || !tgid || !name) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', true); return; }
  let res;
  if (id) {
    res = await fetch(`${API}/api/admin/reps/${id}`, { method:'PATCH', ...hj(), body: JSON.stringify({code, full_name: name}) });
  } else {
    res = await fetch(`${API}/api/admin/reps`, { method:'POST', ...hj(), body: JSON.stringify({code, telegram_id: tgid, full_name: name}) });
  }
  if (res.ok) { closeModal('rep-modal'); showToast(id ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ' : '–î–æ–±–∞–≤–ª–µ–Ω'); loadReps(); }
  else { const d = await res.json(); showToast(d.detail || '–û—à–∏–±–∫–∞', true); }
}

async function toggleRep(id, isActive) {
  await fetch(`${API}/api/admin/reps/${id}`, { method:'PATCH', ...hj(), body: JSON.stringify({is_active: !isActive}) });
  showToast(isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
  loadReps();
}

// ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadOrders() {
  const res = await fetch(`${API}/api/admin/orders`, h());
  const orders = await res.json();
  document.getElementById('stat-total').textContent = orders.length;
  document.getElementById('stat-new').textContent = orders.filter(o=>o.status==='new').length;
  document.getElementById('stat-proc').textContent = orders.filter(o=>o.status==='processing').length;
  document.getElementById('stat-done').textContent = orders.filter(o=>o.status==='done').length;

  const tbody = document.getElementById('orders-tbody');
  if (!orders.length) { tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><span class="empty-icon">üì¶</span>–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div></td></tr>`; return; }
  tbody.innerHTML = orders.map(o => {
    const itemsHtml = o.items.map(i => `<span class="order-item-tag">${i.product_name}: ${i.quantity} ${i.unit}</span>`).join('');
    const isHalf = o.payment_percent === 50;
    return `<tr>
      <td><span style="font-family:var(--mono);color:var(--muted)">#${o.id}</span></td>
      <td style="font-size:13px;white-space:nowrap">${o.created_at}</td>
      <td>
        <span style="font-family:var(--mono);font-weight:700;font-size:16px;color:var(--primary)">${o.rep_code}</span>
        <div style="font-size:12px;color:var(--muted)">${o.full_name}</div>
      </td>
      <td style="font-size:13px">${o.institution}</td>
      <td>
        <div style="font-weight:700">${o.payment_amount?.toFixed(2)}</div>
        <div style="font-size:12px;color:var(--muted)">–∏–∑ ${o.total_price?.toFixed(2)}</div>
        <div class="order-items-list">${itemsHtml}</div>
      </td>
      <td><span class="badge ${isHalf?'badge-low':'badge-ok'}">${o.payment_percent}%</span></td>
      <td><span class="badge badge-${o.status}">${statusLabel(o.status)}</span></td>
      <td><div class="td-actions">
        <select class="btn btn-sm btn-ghost" style="cursor:pointer" onchange="updateOrderStatus(${o.id},this.value)">
          <option value="new"        ${o.status==='new'?'selected':''}>–ù–æ–≤–∞—è</option>
          <option value="processing" ${o.status==='processing'?'selected':''}>–í —Ä–∞–±–æ—Ç–µ</option>
          <option value="done"       ${o.status==='done'?'selected':''}>–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
          <option value="cancelled"  ${o.status==='cancelled'?'selected':''}>–û—Ç–º–µ–Ω–µ–Ω–∞</option>
        </select>
      </div></td>
    </tr>`;
  }).join('');
}

function statusLabel(s) {
  return {new:'–ù–æ–≤–∞—è',processing:'–í —Ä–∞–±–æ—Ç–µ',done:'–í—ã–ø–æ–ª–Ω–µ–Ω–∞',cancelled:'–û—Ç–º–µ–Ω–µ–Ω–∞'}[s]||s;
}

async function updateOrderStatus(id, status) {
  await fetch(`${API}/api/admin/orders/${id}/status`, { method:'PATCH', ...hj(), body: JSON.stringify({status}) });
  showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
}

// ‚îÄ‚îÄ CONFIRM + DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pendingDelete = null;
function confirmDelete(type, id, name) {
  pendingDelete = { type, id };
  document.getElementById('confirm-title').textContent = `–£–¥–∞–ª–∏—Ç—å ${type==='rep'?'–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è':'–ø—Ä–µ–ø–∞—Ä–∞—Ç'}?`;
  document.getElementById('confirm-text').textContent = `¬´${name}¬ª –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.`;
  document.getElementById('confirm-ok-btn').onclick = execDelete;
  openModal('confirm-modal');
}

async function execDelete() {
  const { type, id } = pendingDelete;
  const url = type === 'rep' ? `${API}/api/admin/reps/${id}` : `${API}/api/admin/products/${id}`;
  const res = await fetch(url, { method:'DELETE', ...h() });
  if (res.ok) {
    closeModal('confirm-modal');
    showToast('–£–¥–∞–ª–µ–Ω–æ');
    type === 'rep' ? loadReps() : loadProducts();
  } else { showToast('–û—à–∏–±–∫–∞', true); }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); }));

let toastTimer;
function showToast(msg, error=false) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show' + (error?' error':'');
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.className='', 3000);
}
</script>
</body>
</html>
